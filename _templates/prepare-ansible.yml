parameters:
  - name: pythonVenvPath
    type: string
    default: "$(System.DefaultWorkingDirectory)/.venv"

  - name: pythonVenvCacheVersion
    type: string
    default: "1"

  - name: pythonRequirementsFileRelativePath
    type: string
    default: "requirements.txt"

  - name: ansibleRequirementsFileRelativePath
    type: string
    default: "requirements.yml"

  - name: ansibleRepository
    type: string
    default: self

  - name: ansibleRepositoryAnsiblePath
    type: string
    default: "ansible"

  - name: ansibleSshConfigurations
    type: object
    default:
      - group: "all"
        user: "ansible"
        keySecretFileName: ""
        keyPassphrase: ""


steps:
  - template: _templates/self_checkout.yml

  - checkout: ${{ parameters.ansibleRepository }}
    displayName: "Sparse Checkout Ansible Repository"
    path: "ansible"
    sparseCheckoutDirectories: "${{ parameters.ansibleRepositoryAnsiblePath }}"

  - task: Bash@3
    name: "setupEnvironment"
    displayName: "Setup Python Environment"
    inputs:
      targetType: "inline"
      script: |
        echo "##[group]Setup Python Virtual Environment"
            python3 -m venv ${{ parameters.pythonVenvPath }}
            ${{ parameters.pythonVenvPath }}/bin/pip install --upgrade pip
        echo "##[endgroup]"
      failOnStderr: true

  - task: Bash@3
    name: "createVenvCacheKey"
    displayName: "Create Cache Key for Venv"
    inputs:
      targetType: "inline"
      script: |
        if [ -f "$(Pipeline.Workspace)/ansible/${{ parameters.ansibleRepositoryAnsiblePath }}/${{ parameters.pythonRequirementsFileRelativePath }}" ]; then
            echo "##vso[task.setvariable variable=venvCacheKey;]venv | v${{ parameters.pythonVenvCacheVersion }} | "$(Agent.OS)" | $(Pipeline.Workspace)/ansible/${{ parameters.ansibleRepositoryAnsiblePath }}/${{ parameters.pythonRequirementsFileRelativePath }}"
        else
            echo "##vso[task.setvariable variable=venvCacheKey;]venv | v${{ parameters.pythonVenvCacheVersion }} | $(Agent.OS)"
        fi
      failOnStderr: true

  - task: Cache@2
    name: "cacheVenv"
    displayName: "Cache Python venv"
    inputs:
      key: "$(venvCacheKey)"
      path: ${{ parameters.pythonVenvPath }}
      cacheHitVar: cacheRestored

  - task: Bash@3
    name: "installDependencies"
    displayName: "Install Dependencies"
    condition: ne(variables.cacheRestored, 'true')
    inputs:
      targetType: "inline"
      script: |
        echo "##[group]Install Ansible"
            ${{ parameters.pythonVenvPath }}/bin/pip install --upgrade ansible
        echo "##[endgroup]"

        if [ -f "$(Pipeline.Workspace)/ansible/${{ parameters.ansibleRepositoryAnsiblePath }}/${{ parameters.pythonRequirementsFileRelativePath }}" ]; then
        echo "##[group]Install pip requirements"
            ${{ parameters.pythonVenvPath }}/bin/pip install --upgrade -r $(Pipeline.Workspace)/ansible/${{ parameters.ansibleRepositoryAnsiblePath }}/${{ parameters.pythonRequirementsFileRelativePath }}
        echo "##[endgroup]"
        else
            echo "No pip requirements file found at $(Pipeline.Workspace)/ansible/${{ parameters.ansibleRepositoryAnsiblePath }}/${{ parameters.pythonRequirementsFileRelativePath }}, skipping pip dependencies installation."
        fi

        if [ -f "$(Pipeline.Workspace)/ansible/${{ parameters.ansibleRepositoryAnsiblePath }}/${{ parameters.ansibleRepositoryAnsiblePath }}" ]; then
        echo "##[group]Install ansible-galaxy collections"
            ${{ parameters.pythonVenvPath }}/bin/ansible-galaxy collection install --force -r $(Pipeline.Workspace)/ansible/${{ parameters.ansibleRepositoryAnsiblePath }}/${{ parameters.ansibleRequirementsFileRelativePath }}
        echo "##[endgroup]"
        else
            echo "No Ansible Galaxy requirements file found at $(Pipeline.Workspace)/ansible/${{ parameters.ansibleRepositoryAnsiblePath }}/${{ parameters.ansibleRequirementsFileRelativePath }}, skipping Ansible Galaxy collections installation."
        fi
      failOnStderr: true

  - ${{ each sshConfig in parameters.ansibleSshConfigurations }}:
    - task: DownloadSecureFile@1
      name: ${{ sshConfig.group }}Key
      displayName: "Fetch ${{ sshConfig.group }} SSH Key"
      inputs:
        secureFile: "${{ sshConfig.keySecretFileName }}"

    - task: Bash@3
      name: ${{ sshConfig.group }}KeyPermissions
      displayName: 'Set Permissions for ${{ sshConfig.group }} SSH Key'
      env:
        KEY_PATH: $(${{ sshConfig.group }}Key.secureFilePath)
      inputs:
        targetType: "inline"
        script: |
          echo "Set Permissions (600) for ${{ sshConfig.group }} SSH Key at $KEY_PATH"
          chmod 600 "$KEY_PATH"
